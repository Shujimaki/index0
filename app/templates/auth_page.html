<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YANIG - Login/Register</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body {
            background-color: #f5f0eb;
            font-family: 'Inter', sans-serif;
        }
        /* Logo Styles */
        .logo-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            color: #333;
            font-weight: 700;
            letter-spacing: 4px;
            margin-top: 10px;
        }
        /* Card & Button Styles */
        .login-box, .registration-box {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); 
        }
        .primary-action-button { /* Applied to LOGIN and REGISTER */
            background-color: #e53e3e !important;
        }
        .secondary-action-button { /* Applied to the 'Login' button on registration form */
            background-color: #b83131 !important;
        }
        .primary-action-button, .secondary-action-button { 
            transition: background-color 0.3s ease, transform 0.1s;
        }
        .primary-action-button:hover {
            background-color: #c53030 !important;
        }
        .secondary-action-button:hover {
            background-color: #a82b2b !important;
        }
        .primary-action-button:active, .secondary-action-button:active {
            transform: scale(0.98);
        }
        /* Input & Select Styles */
        .custom-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            /* SVG for the dropdown arrow, adjusted to use Flask's url_for for API calls if needed, 
               but kept inline here for simplicity and dependency-free styling. */
            background-image: url('data:image/svg+xml;utf8,<svg fill="%234A5568" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        /* Registration Header Styling FIX */
        .registration-yanig-text {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            color: #333;
            font-weight: 400;
            line-height: 1; 
            margin-top: 2px; 
        }
        .registration-yanig-group {
            display: flex;
            flex-direction: column;
            align-items: center; 
            margin-right: 12px; 
        }
        .registration-title {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #333;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="login-container w-full h-full flex items-center justify-center">
        
        <div id="loginCard" class="login-box bg-white p-8 sm:p-10 rounded-xl w-full max-w-md text-center">
            
            <div class="logo-section mb-8">
                <img src="{{ logo_url }}" 
                     alt="YANIG Logo" 
                     class="w-24 h-24 mx-auto block mb-2 rounded-lg">
                <h1 class="logo-text">YANIG</h1>
            </div>

            <form class="login-form" method="POST" action="{{ url_for('web.login') }}" onsubmit="showTemporaryMessage('Attempting login for: ' + this.username.value + '...', '#e53e3e');">
                
                <input type="text" name="username" placeholder="Username" required
                       class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-lg focus:border-[#e53e3e] focus:outline-none transition duration-150">
                
                <input type="password" name="password" placeholder="Password" required
                       class="w-full p-3 mb-8 border border-gray-300 rounded-lg text-lg focus:border-[#e53e3e] focus:outline-none transition duration-150">

                <button type="submit" class="primary-action-button w-full text-white p-3 rounded-lg text-xl font-bold tracking-wide cursor-pointer">
                    LOGIN
                </button>
            </form>

            <p class="signup-prompt mt-5 text-sm text-gray-600">
                Don't have an account? 
                <a href="#" class="signup-link text-blue-600 font-semibold hover:underline" 
                   onclick="event.preventDefault(); toggleForm('registration');">
                    Sign Up
                </a>
            </p>
            <div id="messageBox" class="mt-4 text-center text-sm font-medium" style="min-height: 18px;"></div>
        </div>

        <div id="registrationCard" class="registration-box bg-white p-8 sm:p-10 rounded-xl w-full max-w-md hidden">
            
            <div class="flex items-center mb-8">
                <div class="registration-yanig-group">
                    <img src="{{ logo_url }}" 
                         alt="YANIG Logo" 
                         class="w-8 h-8 rounded-full"> 
                    <p class="registration-yanig-text">YANIG</p>
                </div>
                <h2 class="registration-title text-2xl font-bold text-gray-800 tracking-wide">REGISTRATION</h2>
            </div>

            <form class="registration-form" method="POST" action="{{ url_for('web.register') }}" onsubmit="showTemporaryMessage('Attempting registration...', '#e53e3e', 'registrationMessageBox');">
                
                <label for="reg-name" class="block text-left text-gray-700 text-base font-semibold mb-2">Name</label>
                <input type="text" id="reg-name" name="name" placeholder="Full Name" required
                       class="w-full p-3 mb-5 border-2 border-[#b83131] rounded-full text-lg focus:outline-none focus:ring-1 focus:ring-[#e53e3e] transition duration-150">
                
                <label for="reg-email" class="block text-left text-gray-700 text-base font-semibold mb-2">Email</label>
                <input type="email" id="reg-email" name="email" placeholder="Email" required
                       class="w-full p-3 mb-5 border-2 border-[#b83131] rounded-full text-lg focus:outline-none focus:ring-1 focus:ring-[#e53e3e] transition duration-150">

                <div class="flex flex-wrap -mx-2 mb-4">
                    <div class="w-full px-2">
                        <label for="reg-region" class="block text-left text-gray-700 text-base font-semibold mb-2">Region</label>
                        <div class="relative">
                            <select id="reg-region" name="region" required
                                    class="custom-select w-full p-3 border-2 border-[#b83131] rounded-full text-lg bg-white focus:outline-none focus:ring-1 focus:ring-[#e53e3e] transition duration-150">
                                <option value="" disabled selected>Select Region</option>
                                
                                {% for region in regions %}
                                <option value="{{ region.value }}">{{ region.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap -mx-2 mb-8">
                    <div class="w-1/2 px-2">
                        <label for="reg-province" class="block text-left text-gray-700 text-base font-semibold mb-2">Province</label>
                        <div class="relative">
                            <select id="reg-province" name="province" required disabled
                                    class="custom-select w-full p-3 border-2 border-[#b83131] rounded-full text-lg bg-white focus:outline-none focus:ring-1 focus:ring-[#e53e3e] transition duration-150">
                                <option value="" disabled selected>Select Region First</option>
                            </select>
                        </div>
                    </div>
                    <div class="w-1/2 px-2">
                        <label for="reg-city" class="block text-left text-gray-700 text-base font-semibold mb-2">City/Municipality</label>
                        <div class="relative">
                            <select id="reg-city" name="city" required disabled
                                    class="custom-select w-full p-3 border-2 border-[#b83131] rounded-full text-lg bg-white focus:outline-none focus:ring-1 focus:ring-[#e53e3e] transition duration-150">
                                <option value="" disabled selected>Select Province First</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between space-x-4">
                    <button type="button" class="secondary-action-button w-1/2 text-white p-3 rounded-full text-xl font-bold tracking-wide cursor-pointer"
                            onclick="toggleForm('login');">
                        Login
                    </button>
                    <button type="submit" class="primary-action-button w-1/2 text-white p-3 rounded-full text-xl font-bold tracking-wide cursor-pointer">
                        Register
                    </button>
                </div>
            </form>
            <div id="registrationMessageBox" class="mt-4 text-center text-sm font-medium" style="min-height: 18px;"></div>
        </div>
    </div>

    <script>
        /**
         * Displays a temporary message in a specified message box.
         */
        function showTemporaryMessage(msg, color, boxId = 'messageBox') {
            const msgBox = document.getElementById(boxId);
            if (msgBox.timeoutId) {
                clearTimeout(msgBox.timeoutId);
            }

            msgBox.textContent = msg;
            msgBox.style.color = color;
            
            msgBox.timeoutId = setTimeout(() => {
                msgBox.textContent = '';
                msgBox.style.color = '';
                msgBox.timeoutId = null;
            }, 3000);
        }

        /**
         * Toggles the visibility between the login and registration forms.
         */
        function toggleForm(formToShow) {
            const loginCard = document.getElementById('loginCard');
            const registrationCard = document.getElementById('registrationCard');
            const msgBox = document.getElementById('messageBox');
            const regMsgBox = document.getElementById('registrationMessageBox');

            // Clear any existing messages when switching forms
            msgBox.textContent = '';
            regMsgBox.textContent = '';

            if (formToShow === 'registration') {
                loginCard.classList.add('hidden');
                registrationCard.classList.remove('hidden');
            } else { // formToShow === 'login'
                registrationCard.classList.add('hidden');
                loginCard.classList.remove('hidden');
            }
        }
        
        // ==========================================================
        // NEW JAVASCRIPT FOR 3-TIER DEPENDENT DROPDOWNS
        // This logic communicates with the Flask API routes.
        // ==========================================================

        document.addEventListener('DOMContentLoaded', function() {
            const regionSelect = document.getElementById('reg-region');
            const provinceSelect = document.getElementById('reg-province');
            const citySelect = document.getElementById('reg-city');

            // --- Helper function to reset a dropdown ---
            function resetDropdown(selectElement, defaultText) {
                selectElement.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
                selectElement.disabled = true;
            }

            // --- Function to populate Provinces based on Region ---
            async function populateProvinces(regionCode) {
                resetDropdown(provinceSelect, 'Loading Provinces...');
                resetDropdown(citySelect, 'Select Province First');

                if (regionCode) {
                    try {
                        // API call to Flask: /api/provinces/<region_code>
                        // NOTE: Uses hardcoded path, which matches your Flask route
                        const response = await fetch(`/api/provinces/${regionCode}`);
                        const provinces = await response.json();

                        provinceSelect.innerHTML = '<option value="" disabled selected>Select Province</option>';

                        if (provinces.length > 0) {
                            provinces.forEach(province => {
                                const option = document.createElement('option');
                                option.value = province.value;
                                option.textContent = province.name;
                                provinceSelect.appendChild(option);
                            });
                            provinceSelect.disabled = false;
                        } else {
                            resetDropdown(provinceSelect, 'No Provinces Found');
                        }
                    } catch (error) {
                        console.error('Error fetching provinces:', error);
                        resetDropdown(provinceSelect, 'Error Loading');
                    }
                } else {
                    resetDropdown(provinceSelect, 'Select Region First');
                }
            }

            // --- Function to populate Cities based on Province and Region ---
            async function populateCities(regionCode, provinceCode) {
                resetDropdown(citySelect, 'Loading Cities...');

                if (regionCode && provinceCode) {
                    try {
                        // API call to Flask: /api/cities/<region_code>/<province_code>
                        // NOTE: Uses hardcoded path, which matches your Flask route
                        const response = await fetch(`/api/cities/${regionCode}/${provinceCode}`);
                        const cities = await response.json();

                        citySelect.innerHTML = '<option value="" disabled selected>Select City/Municipality</option>';

                        if (cities.length > 0) {
                            cities.forEach(city => {
                                const option = document.createElement('option');
                                option.value = city.value;
                                option.textContent = city.name;
                                citySelect.appendChild(option);
                            });
                            citySelect.disabled = false;
                        } else {
                            resetDropdown(citySelect, 'No Cities Found');
                        }
                    } catch (error) {
                        console.error('Error fetching cities:', error);
                        resetDropdown(citySelect, 'Error Loading');
                    }
                } else {
                    resetDropdown(citySelect, 'Select Province First');
                }
            }

            // --- Event Listeners ---
            
            // 1. When Region changes, load Provinces
            if (regionSelect) {
                regionSelect.addEventListener('change', function() {
                    populateProvinces(this.value);
                });
            }

            // 2. When Province changes, load Cities
            if (provinceSelect) {
                provinceSelect.addEventListener('change', function() {
                    const regionCode = regionSelect.value;
                    // Ensure a region is selected before attempting to fetch cities
                    if (regionCode) {
                        populateCities(regionCode, this.value);
                    }
                });
            }
        });
    </script>
</body>
</html>